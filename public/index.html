<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POC — Duikmateriaal Huur (SEPA QR)</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background:#0b1220; color:#eaf2ff; }
    .app { max-width: 980px; margin: 0 auto; display: grid; gap: var(--gap); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .card { background: #121a2c; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; }
    .grid { display:grid; gap: var(--gap); }
    .items { display:grid; grid-template-columns: 1fr auto auto auto; gap: 10px; align-items:center }
    .items > div { padding: 10px 0; border-bottom: 1px dashed #28365b; }
    .items .hdr { font-weight:600; color:#bcd3ff; border-bottom-color:#3a4f82; }
    .price, .line { text-align:right; font-variant-numeric: tabular-nums; }
    .qtywrap { display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .qtybtn {
      min-width: 44px; min-height: 44px; border-radius: 10px; border:1px solid #2a3d67;
      background:#0f1627; color:#eaf2ff; font-size: 20px; line-height: 1; padding: 0 0 2px;
      touch-action: manipulation; user-select: none;
    }
    .qtyval {
      width: 64px; text-align:center; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
      background:#0f1627; color:#eaf2ff; font-variant-numeric: tabular-nums;
    }
    .totals { display:flex; justify-content: flex-end; gap: 16px; align-items: baseline; }
    .totals .label { color:#bcd3ff; }
    .totals .amount { font-size: 22px; font-weight: 700; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"] { width: 100%; }
    input, select, button, textarea {
      background:#0f1627; color:#eaf2ff; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
    }
    button { cursor:pointer; }
    button.primary { background:#2d67ff; border-color:#2d67ff; color:white; }
    button.ghost { background:transparent; }
    .qrwrap { display:flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    #qrcode { background:white; padding:10px; border-radius:12px; }
    .small { color:#9db6ff; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color:#9db6ff; }
    a { color:#b3c9ff; }
    @media (max-width: 640px){
      .items { grid-template-columns: 1fr auto 1fr auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="grid">
      <h1>POC — Duikmateriaal Huur (SEPA QR)</h1>
      <p class="muted">Kies aantallen met +/–, we berekenen het huurbedrag en maken een EPC-QR (SCT) naar een fictieve rekening. Mededeling = samenvatting (afgekapt tot 140 tekens).</p>
    </header>

    <!-- Artikelen met huurprijzen (fictief, per dag) -->
    <section class="card grid">
      <h2 style="margin:0">Artikelen (huurprijs/dag)</h2>
      <div class="items mono">
        <div class="hdr">Artikel</div>
        <div class="hdr price">€/dag</div>
        <div class="hdr" style="text-align:right">Aantal</div>
        <div class="hdr line">Lijn (€)</div>

        <div>Handschoenen (5 mm neopreen)</div>
        <div class="price" data-price="4.50">4,50</div>
        <div class="qtywrap" data-sku="HANDSCHOENEN">
          <button class="qtybtn" data-action="dec" aria-label="verlaag">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc" aria-label="verhoog">+</button>
        </div>
        <div class="line" data-line="HANDSCHOENEN">0,00</div>

        <div>Vinnen (open heel)</div>
        <div class="price" data-price="9.00">9,00</div>
        <div class="qtywrap" data-sku="VINNEN">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="VINNEN">0,00</div>

        <div>Botjes (schoenen met rits)</div>
        <div class="price" data-price="5.00">5,00</div>
        <div class="qtywrap" data-sku="BOTJES">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="BOTJES">0,00</div>

        <div>Jacket / BCD ("jockey")</div>
        <div class="price" data-price="25.00">25,00</div>
        <div class="qtywrap" data-sku="JACKET">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="JACKET">0,00</div>

        <div>Masker (gehard glas)</div>
        <div class="price" data-price="6.00">6,00</div>
        <div class="qtywrap" data-sku="MASKER">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="MASKER">0,00</div>
      </div>

      <div class="totals">
        <div class="label">Totaal (€/dag):</div>
        <div id="total" class="amount mono">€ 0,00</div>
      </div>
    </section>

    <!-- Ontvanger & QR -->
    <section class="card grid">
      <h2 style="margin:0">Ontvanger (fictief)</h2>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap: var(--gap);">
        <label>Rekeninghouder
          <input id="benefName" type="text" value="DIVE RENTALS POC" />
        </label>
        <label>IBAN (fictief)
          <input id="iban" class="mono" type="text" value="BE73001942760860" />
        </label>
        <label>BIC (optioneel)
          <input id="bic" class="mono" type="text" value="GEBABEBB" />
        </label>
        <label>Mededeling (automatisch)
          <input id="remit" type="text" placeholder="auto gegenereerd" />
        </label>
      </div>
      <p class="small">EPC-SCT payload met ongestructureerde mededeling (max. 140 tekens). We kappen automatisch af.</p>
    </section>

    <section class="card grid">
      <h2 style="margin:0">Genereer QR</h2>
      <div class="row">
        <button id="btnGen" class="primary">Genereer Betaal-QR</button>
        <button id="btnCopy" class="ghost">Kopieer EPC-payload</button>
        <button id="btnSave" class="ghost">Download QR (PNG)</button>
      </div>

      <div class="qrwrap">
        <div id="qrcode"></div>
        <div class="grid" style="min-width: 300px;">
          <div><strong>EPC-payload</strong></div>
          <textarea id="payload" rows="10" class="mono" spellcheck="false" readonly></textarea>
          <div class="small">Scanbaar in de meeste EU-bankapps (SCT). Dit is een demonstratie met fictieve rekening.</div>
        </div>
      </div>
    </section>

    <footer class="small muted">
      Tip: lang indrukken op +/− zorgt voor auto-repeat. Je kan IBAN/BIC/naam altijd aanpassen.
    </footer>
  </div>

  <!-- Externe libs (onderaan body, juiste volgorde) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- App logic -->
  <script>
    // ——— Helpers ———
    const eur = (n) => new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(n);
    const dot2 = (n) => (Math.round((Number(n) + Number.EPSILON) * 100) / 100).toFixed(2);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const MAX_REMIT = 140; // EPC ongestructureerde mededeling max 140 tekens

    // Lees items/prijzen vanuit DOM
    const items = [];
    $('.items .price').each(function(){
      const $price = $(this);
      const label = $price.prev().text().trim();
      const price = parseFloat($price.data('price'));
      const $wrap  = $price.next('.qtywrap');
      const sku = $wrap.data('sku');
      const $input = $wrap.find('.qtyval');
      items.push({ sku, label, price, $input });
    });

    function updateLinesAndTotal() {
      let total = 0;
      items.forEach(({ sku, price, $input }) => {
        const qty = clamp(parseInt($input.val() || '0',10) || 0, 0, 999);
        $input.val(qty);
        const line = qty * price;
        total += line;
        $(`[data-line="${sku}"]`).text(line ? dot2(line).replace('.', ',') : '0,00');
      });
      $('#total').text(eur(total));
      // Placeholder voor mededeling updaten
      $('#remit').attr('placeholder', buildRemittance(true));
      return total;
    }

    // +/− binding met auto-repeat
    function bindQty() {
      $('.qtywrap').each(function(){
        const $wrap = $(this);
        const $input = $wrap.find('.qtyval');
        const $dec = $wrap.find('[data-action="dec"]');
        const $inc = $wrap.find('[data-action="inc"]');

        const step = (delta)=>{ 
          const v = clamp((parseInt($input.val()||'0',10)||0) + delta, 0, 999);
          $input.val(v);
          updateLinesAndTotal();
        };

        let holdTimer=null, repeatTimer=null;
        const startHold = (delta)=>{
          step(delta);
          holdTimer = setTimeout(()=>{ repeatTimer = setInterval(()=>step(delta), 70); }, 350);
        };
        const endHold = ()=>{
          clearTimeout(holdTimer); clearInterval(repeatTimer);
          holdTimer=null; repeatTimer=null;
        };

        $dec.on('click', ()=>step(-1));
        $inc.on('click', ()=>step(1));

        // Touch/Mouse hold
        ['pointerdown','mousedown','touchstart'].forEach(evt=>{
          $dec.on(evt, e=>{ e.preventDefault(); startHold(-1); });
          $inc.on(evt, e=>{ e.preventDefault(); startHold(1); });
        });
        ['pointerup','mouseleave','mouseup','touchend','touchcancel'].forEach(evt=>{
          $dec.on(evt, endHold);
          $inc.on(evt, endHold);
        });

        // Handmatige invoer
        $input.on('input', updateLinesAndTotal);
        $input.on('blur', ()=>{ 
          const v = clamp(parseInt($input.val()||'0',10)||0,0,999); 
          $input.val(v); 
          updateLinesAndTotal(); 
        });
      });
    }

    // EPC payload builder (SCT)
    function buildEpcPayload({ name, iban, bic, amount, remittance }) {
      const lines = [
        'BCD',           // Service tag
        '001',           // Version
        '1',             // Character set (UTF-8)
        'SCT',           // Identification (SEPA Credit Transfer)
        (bic || '').toUpperCase().trim(),
        (name || '').trim().slice(0,70),
        (iban || '').replace(/\s+/g, '').toUpperCase(),
        'EUR' + dot2(amount || 0),
        '',              // Purpose (optional)
        '',              // Structured reference (unused here)
        (remittance || '').trim().slice(0, MAX_REMIT),
        ''               // Beneficiary to originator info (optional)
      ];
      return lines.join('\n');
    }

    // Mededeling op basis van gekozen items (afkappen tot 140)
    function buildRemittance(asPlaceholder=false) {
      const parts = items.map(({ label, $input }) => {
        const qty = parseInt($input.val()||'0',10) || 0;
        if (!qty) return null;
        const base = label.split('(')[0].trim(); // korter
        return `${base}×${qty}`;
      }).filter(Boolean);

      const ts = new Date().toISOString().slice(0,16).replace('T',' ').replace(/:/g,'');
      const suffix = ` — HUUR ${ts}`;

      let text = (parts.length ? parts.join(' / ') : 'GEEN SELECTIE') + suffix;
      if (text.length > MAX_REMIT) {
        text = text.slice(0, MAX_REMIT);
        const lastSep = text.lastIndexOf(' / ');
        if (lastSep > 0 && MAX_REMIT - lastSep < 10) {
          text = text.slice(0, lastSep);
        }
      }
      if (asPlaceholder) return text;

      const manual = $('#remit').val().trim();
      return manual ? manual.slice(0, MAX_REMIT) : text;
    }

    // QR init (div#qrcode leegmaken en vullen)
    let qr = null;
    function renderQR(payload){
      const $box = $('#qrcode');
      $box.empty();
      qr = new QRCode($box[0], {
        text: payload,
        width: 256,
        height: 256,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    function generate() {
      const total = updateLinesAndTotal();
      const name = $('#benefName').val() || 'DIVE RENTALS POC';
      const iban = $('#iban').val() || 'BE73001942760860';
      const bic  = $('#bic').val()  || 'GEBABEBB';
      const remittance = buildRemittance(false);

      const payload = buildEpcPayload({ name, iban, bic, amount: total, remittance });
      $('#payload').val(payload);
      renderQR(payload);
    }

    async function copyPayload() {
      const txt = $('#payload').val();
      if (!txt) { alert('Geen payload om te kopiëren. Genereer eerst de QR.'); return; }
      try {
        await navigator.clipboard.writeText(txt);
        const $btn = $('#btnCopy'); const old = $btn.text();
        $btn.text('Gekopieerd!'); setTimeout(()=> $btn.text(old), 1200);
      } catch {
        alert('Kopiëren mislukt. Selecteer en kopieer handmatig.');
      }
    }

    function savePng() {
      const $qr = $('#qrcode');
      const $img = $qr.find('img');   // qrcode.js kan <img> renderen
      const $canvas = $qr.find('canvas'); // of <canvas>, afhankelijk van omgeving

      if ($canvas.length) {
        const link = document.createElement('a');
        link.download = 'betaal-qr.png';
        link.href = $canvas[0].toDataURL('image/png');
        link.click();
      } else if ($img.length) {
        const link = document.createElement('a');
        link.download = 'betaal-qr.png';
        link.href = $img.attr('src');
        link.click();
      } else {
        alert('Genereer eerst de QR.');
      }
    }

    // Init
    bindQty();
    updateLinesAndTotal();

    // Events
    $('#btnGen').on('click', generate);
    $('#btnCopy').on('click', copyPayload);
    $('#btnSave').on('click', savePng);
  </script>
</body>
</html>
