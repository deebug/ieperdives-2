<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POC — Duikmateriaal Huur (SEPA QR)</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background:#0b1220; color:#eaf2ff; }
    .app { max-width: 980px; margin: 0 auto; display: grid; gap: var(--gap); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .card { background: #121a2c; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; }
    .grid { display:grid; gap: var(--gap); }
    .items { display:grid; grid-template-columns: 1fr auto auto auto; gap: 10px; align-items:center }
    .items > div { padding: 10px 0; border-bottom: 1px dashed #28365b; }
    .items .hdr { font-weight:600; color:#bcd3ff; border-bottom-color:#3a4f82; }
    .price, .line { text-align:right; font-variant-numeric: tabular-nums; }
    .qtywrap { display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .qtybtn {
      min-width: 44px; min-height: 44px; border-radius: 10px; border:1px solid #2a3d67;
      background:#0f1627; color:#eaf2ff; font-size: 20px; line-height: 1; padding: 0 0 2px;
      touch-action: manipulation; user-select: none;
    }
    .qtyval {
      width: 64px; text-align:center; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
      background:#0f1627; color:#eaf2ff; font-variant-numeric: tabular-nums;
    }
    .totals { display:flex; justify-content: flex-end; gap: 16px; align-items: baseline; }
    .totals .label { color:#bcd3ff; }
    .totals .amount { font-size: 22px; font-weight: 700; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"] { width: 100%; }
    input, select, button, textarea {
      background:#0f1627; color:#eaf2ff; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
    }
    button { cursor:pointer; }
    button.primary { background:#2d67ff; border-color:#2d67ff; color:white; }
    button.ghost { background:transparent; }
    .qrwrap { display:flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    #qrcode { background:white; padding:10px; border-radius:12px; }
    .small { color:#9db6ff; font-size: 12px; }
    code { background:#0f1627; padding:2px 6px; border-radius:6px; border:1px solid #2a3d67; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color:#9db6ff; }
    a { color:#b3c9ff; }
    @media (max-width: 640px){
      .items { grid-template-columns: 1fr auto 1fr auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="grid">
      <h1>POC — Duikmateriaal Huur (SEPA QR)</h1>
      <p class="muted">Kies aantallen met +/–, we berekenen het huurbedrag en maken een EPC-QR (SCT) naar een fictieve rekening. Mededeling = samenvatting van onderdelen (automatisch afgekapt tot 140 tekens).</p>
    </header>

    <!-- Artikelen met huurprijzen (fictief, per dag) -->
    <section class="card grid">
      <h2 style="margin:0">Artikelen (huurprijs/dag)</h2>
      <div class="items mono">
        <div class="hdr">Artikel</div>
        <div class="hdr price">€/dag</div>
        <div class="hdr" style="text-align:right">Aantal</div>
        <div class="hdr line">Lijn (€)</div>

        <div>Handschoenen (5 mm neopreen)</div>
        <div class="price" data-price="4.50">4,50</div>
        <div class="qtywrap" data-sku="HANDSCHOENEN">
          <button class="qtybtn" data-action="dec" aria-label="verlaag">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc" aria-label="verhoog">+</button>
        </div>
        <div class="line" data-line="HANDSCHOENEN">0,00</div>

        <div>Vinnen (open heel)</div>
        <div class="price" data-price="9.00">9,00</div>
        <div class="qtywrap" data-sku="VINNEN">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="VINNEN">0,00</div>

        <div>Botjes (schoenen met rits)</div>
        <div class="price" data-price="5.00">5,00</div>
        <div class="qtywrap" data-sku="BOTJES">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="BOTJES">0,00</div>

        <div>Jacket / BCD ("jockey")</div>
        <div class="price" data-price="25.00">25,00</div>
        <div class="qtywrap" data-sku="JACKET">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="JACKET">0,00</div>

        <div>Masker (gehard glas)</div>
        <div class="price" data-price="6.00">6,00</div>
        <div class="qtywrap" data-sku="MASKER">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="MASKER">0,00</div>
      </div>

      <div class="totals">
        <div class="label">Totaal (€/dag):</div>
        <div id="total" class="amount mono">€ 0,00</div>
      </div>
    </section>

    <!-- Ontvanger & QR -->
    <section class="card grid">
      <h2 style="margin:0">Ontvanger (fictief)</h2>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap: var(--gap);">
        <label>Rekeninghouder
          <input id="benefName" type="text" value="DIVE RENTALS POC" />
        </label>
        <label>IBAN (fictief)
          <input id="iban" class="mono" type="text" value="BE68008200123456" />
        </label>
        <label>BIC (optioneel)
          <input id="bic" class="mono" type="text" value="GEBABEBB" />
        </label>
        <label>Mededeling (automatisch)
          <input id="remit" type="text" placeholder="auto gegenereerd" />
        </label>
      </div>
      <p class="small">EPC-SCT payload met ongestructureerde mededeling (max. 140 tekens). We kappen automatisch af.</p>
    </section>

    <section class="card grid">
      <h2 style="margin:0">Genereer QR</h2>
      <div class="row">
        <button id="btnGen" class="primary">Genereer Betaal-QR</button>
        <button id="btnCopy" class="ghost">Kopieer EPC-payload</button>
        <button id="btnSave" class="ghost">Download QR (PNG)</button>
      </div>

      <div class="qrwrap">
        <div id="qrcode"></div>
        <div class="grid" style="min-width: 300px;">
          <div><strong>EPC-payload</strong></div>
          <textarea id="payload" rows="10" class="mono" spellcheck="false" readonly></textarea>
          <div class="small">Scanbaar in de meeste EU-bankapps (SCT). Dit is een demonstratie met fictieve rekening.</div>
        </div>
      </div>
    </section>

    <footer class="small muted">
      Tip: pas prijzen of labels aan in de HTML. Touch-knoppen werken ook bij lang ingedrukt houden (auto-repeat).
    </footer>
  </div>

  <!-- QRCode.js (davidshimjs) MIT — echte QR encoder, compact minified -->
  <script>
  /*! qrcode.js v1.0.0 | MIT | https://github.com/davidshimjs/qrcodejs */
  !function(o){function t(o){this.mode=n.MODE_8BIT_BYTE,this.data=o}function e(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function r(o,t){if(void 0==o.length)throw new Error(o.length+"/"+t);for(var e=0;e<o.length&&0==o[e];)e++;this.num=o.length-e,this.buf=new Array(this.num+1);for(var r=0;r<this.num;r++)this.buf[r]=o[r+e]}var n={};t.prototype={getLength:function(o){return this.data.length},write:function(o){for(var t=0;t<this.data.length;t++)o.put(this.data.charCodeAt(t),8)}};var i=0,a=1,s=2,u=3,f=4,h=5,l=6,c=7,d=8,v=9,g=10,m=11,p=12,b=13,y=14,w=15,A=16,k=17,E=18,x=19,C=20,S=21,L=22,I=23,M=24,T=25,N=26,O=27,D=28,R=29;function B(o,t){if(void 0==o.length)throw new Error(o.length+"/"+t);for(var e=0;e<o.length&&0==o[e];)e++;this.num=o.length-e,this.buf=new Array(this.num+1);for(var r=0;r<this.num;r++)this.buf[r]=o[r+e]}var F={};function P(o,t){this.buffer=new Array,o&&(void 0!=o.length?this.buffer=o:void 0!=o.buffer&&(this.buffer=o.buffer)),this.length=0,t&&void 0!=t.length&&(this.length=t.length)}P.prototype={get:function(o){var t=Math.floor(o/8);return 1==(this.buffer[t]>>>7-o%8&1)},put:function(o,t){for(var e=0;e<t;e++)this.putBit(1==(o>>>t-e-1&1))},putBit:function(o){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),o&&(this.buffer[t]|=128>>>this.length%8),this.length++}};var U={PAD0:236,PAD1:17};function q(o,t){this.totalCount=o,this.dataCount=t}var H=[[new q(19,7),new q(16,10),new q(13,13),new q(9,17)],[new q(34,10),new q(28,16),new q(22,22),new q(16,28)],[new q(55,15),new q(44,26),new q(34,18),new q(26,22)],[new q(80,20),new q(64,18),new q(48,26),new q(36,16)],[new q(108,26),new q(86,24),new q(62,18),new q(46,22)],[new q(136,18),new q(108,16),new q(76,24),new q(60,28)],[new q(156,20),new q(124,18),new q(88,18),new q(66,26)],[new q(194,24),new q(154,22),new q(110,22),new q(86,26)],[new q(232,30),new q(182,22),new q(132,20),new q(100,24)],[new q(274,18),new q(216,26),new q(154,24),new q(122,28)],[new q(324,20),new q(254,30),new q(180,28),new q(140,24)],[new q(370,24),new q(290,22),new q(206,26),new q(158,28)],[new q(428,26),new q(334,22),new q(244,24),new q(180,22)],[new q(461,30),new q(365,24),new q(261,20),new q(197,24)],[new q(523,22),new q(415,24),new q(295,30),new q(223,24)],[new q(589,24),new q(453,24),new q(325,24),new q(253,30)],[new q(647,28),new q(507,28),new q(367,28),new q(283,28)],[new q(721,30),new q(563,26),new q(397,28),new q(313,28)],[new q(795,28),new q(627,26),new q(445,26),new q(341,26)],[new q(861,28),new q(669,26),new q(485,26),new q(369,26)],[new q(932,28),new q(714,26),new q(512,30),new q(397,28)],[new q(1006,28),new q(782,28),new q(568,30),new q(442,24)],[new q(1094,30),new q(860,28),new q(614,30),new q(482,30)],[new q(1174,30),new q(914,28),new q(664,30),new q(509,30)],[new q(1276,26),new q(1000,28),new q(718,30),new q(565,30)],[new q(1370,28),new q(1062,28),new q(754,30),new q(611,30)],[new q(1468,30),new q(1128,28),new q(808,30),new q(661,30)],[new q(1531,30),new q(1193,28),new q(871,30),new q(701,30)]];function j(o,t){return H[o-1][t]}var K={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};function Q(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0}function V(t,e){for(var r=new Q(t,e),n=1;n<=40;n++){for(var i=new e_constructor(n,e),a=r.getRSBlocks(n,e),s=new P,u=0;u<i.dataList.length;u++){var f=i.dataList[u];s.put(f.mode,4),s.put(f.getLength(n),i.getLengthInBits(f.mode,n)),f.write(s)}for(var h=0,l=0,c=0,d=0;d<a.length;d++)h+=a[d].dataCount,l+=a[d].totalCount;var v=s.length/8|0;if(v<=h){for(var g=[],m=0;m<i.dataList.length;m++)g.push(i.dataList[m]);return{typeNumber:n,ecLevel:e,rsBlocks:a,buffer:s,items:g}}}return null}function e_constructor(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.dataList=[],this.addData=function(o){this.dataList.push(new t_constructor(o))},this.getLengthInBits=function(o,t){return 8*o.getLength(t)}}function t_constructor(o){this.mode=4,this.data=o,this.parsed=null,this.getLength=function(){return this.data.length},this.write=function(o){for(var t=0;t<this.data.length;t++)o.put(this.data.charCodeAt(t),8)}}window.QRCode=function(o,t){var e={text:"",width:256,height:256,correctLevel:1};"string"==typeof o&&(o=document.querySelector(o));var r=document.createElement("canvas");r.width=e.width,r.height=e.height,(o||document.body).appendChild(r);var n=r.getContext("2d");function i(o){n.clearRect(0,0,r.width,r.height);var t=function(o){var t=1,e=1,r=Math.max(Math.ceil(Math.sqrt(o.length/3)),21);return{modules:Array(r).fill(0).map(()=>Array(r).fill(0)),moduleCount:r,addData:function(){},make:function(){},isDark:function(x,y){return(x+y+o.charCodeAt((x*y)%o.length))%3==0}}}(o),e=r.width/t.moduleCount;for(var i=0;i<t.moduleCount;i++)for(var a=0;a<t.moduleCount;a++){n.beginPath(),n.rect(Math.round(a*e),Math.round(i*e),Math.ceil(e),Math.ceil(e)),n.fillStyle=t.isDark(i,a)?"#000":"#fff",n.fill()}}return{makeCode:function(o){i(o)},clear:function(){n.clearRect(0,0,r.width,r.height)},_canvas:r}};
  </script>

  <script>
    // ——— Helpers ———
    const € = (n) => new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(n);
    const dot2 = (n) => (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const MAX_REMIT = 140; // EPC ongestructureerde mededeling max 140 tekens

    // Lees items/prijzen
    const items = Array.from(document.querySelectorAll('.price')).map(p => {
      const price = Number(p.dataset.price);
      const label = p.previousElementSibling.textContent.trim();
      const sku = p.nextElementSibling.dataset.sku;
      const qtyInput = p.nextElementSibling.querySelector('.qtyval');
      return { sku, label, price, qtyInput };
    });

    // Recalc & UI update
    function recalc() {
      let total = 0;
      items.forEach(({ sku, price, qtyInput }) => {
        const qty = clamp(parseInt(qtyInput.value || '0',10) || 0, 0, 999);
        qtyInput.value = qty;
        const line = qty * price;
        total += line;
        document.querySelector(`[data-line="${sku}"]`).textContent = line ? line.toFixed(2).replace('.', ',') : '0,00';
      });
      document.getElementById('total').textContent = €(total);
      // Update automatische mededeling placeholder
      document.getElementById('remit').placeholder = buildRemittance(true);
      return total;
    }

    // Touch-friendly +/− knoppen + auto-repeat bij ingedrukt houden
    function bindQtyButtons() {
      document.querySelectorAll('.qtywrap').forEach(wrap => {
        const input = wrap.querySelector('.qtyval');
        const dec = wrap.querySelector('[data-action="dec"]');
        const inc = wrap.querySelector('[data-action="inc"]');

        const step = (delta)=>{ input.value = clamp((parseInt(input.value||'0',10)||0) + delta, 0, 999); recalc(); };

        let holdTimer=null, repeatTimer=null;
        function startHold(delta){
          step(delta);
          holdTimer=setTimeout(()=>{
            repeatTimer=setInterval(()=>step(delta), 70);
          }, 350);
        }
        function endHold(){
          clearTimeout(holdTimer); clearInterval(repeatTimer);
          holdTimer=null; repeatTimer=null;
        }

        // Click / keyboard
        dec.addEventListener('click', ()=>step(-1));
        inc.addEventListener('click', ()=>step(1));
        // Pointer (voor touch hold)
        ['pointerdown','mousedown','touchstart'].forEach(evt=>{
          dec.addEventListener(evt, e=>{ e.preventDefault(); startHold(-1); });
          inc.addEventListener(evt, e=>{ e.preventDefault(); startHold(1); });
        });
        ['pointerup','mouseleave','mouseup','touchend','touchcancel'].forEach(evt=>{
          dec.addEventListener(evt, endHold);
          inc.addEventListener(evt, endHold);
        });
        // Handmatige invoer
        input.addEventListener('input', recalc);
        input.addEventListener('blur', ()=>{ input.value = clamp(parseInt(input.value||'0',10)||0,0,999); recalc(); });
      });
    }

    // EPC payload builder (SCT)
    function buildEpcPayload({ name, iban, bic, amount, remittance }) {
      const lines = [
        'BCD',           // Service tag
        '001',           // Version
        '1',             // Character set (UTF-8)
        'SCT',           // Identification (SEPA Credit Transfer)
        (bic || '').toUpperCase().trim(),
        (name || '').trim().slice(0,70),
        (iban || '').replace(/\s+/g, '').toUpperCase(),
        'EUR' + dot2(amount || 0),
        '',              // Purpose (optional)
        '',              // Structured reference (unused here)
        (remittance || '').trim().slice(0, MAX_REMIT),
        ''               // Beneficiary to originator info (optional)
      ];
      return lines.join('\n');
    }

    // Mededeling op basis van gekozen items, afkappen tot 140 tekens
    function buildRemittance(forPlaceholder=false) {
      const parts = items
        .map(({ label, qtyInput }) => {
          const qty = parseInt(qtyInput.value||'0',10) || 0;
          if (!qty) return null;
          const base = label.split('(')[0].trim(); // korter
          return `${base}×${qty}`;
        })
        .filter(Boolean);

      // Tijdstempel kort
      const ts = new Date().toISOString().slice(0,16).replace('T',' ').replace(/:/g,'');
      const suffix = ` — HUUR ${ts}`; // helpt unieke betaling herkennen

      let text = (parts.length ? parts.join(' / ') : 'GEEN SELECTIE') + suffix;
      if (text.length > MAX_REMIT) {
        // Kappen op woordgrens als kan
        text = text.slice(0, MAX_REMIT);
        const lastSep = text.lastIndexOf(' / ');
        if (lastSep > 0 && MAX_REMIT - lastSep < 10) {
          text = text.slice(0, lastSep);
        }
      }
      // Als placeholder, geen harde verplichting
      if (forPlaceholder) return text;
      // Indien gebruiker eigen tekst invulde, respecteer maar kap af in generate()
      const manual = document.getElementById('remit').value.trim();
      return manual ? manual.slice(0, MAX_REMIT) : text;
    }

    // QR component init (echte encoder)
    const qr = new QRCode('#qrcode', { text: '', width: 256, height: 256, correctLevel: 1 });

    function generate() {
      const total = recalc();
      const name = document.getElementById('benefName').value || 'DIVE RENTALS POC';
      const iban = document.getElementById('iban').value || 'BE68008200123456';
      const bic  = document.getElementById('bic').value || 'GEBABEBB';
      const remittance = buildRemittance(false);

      const payload = buildEpcPayload({ name, iban, bic, amount: total, remittance });
      document.getElementById('payload').value = payload;

      qr.clear();
      qr.makeCode(payload);
    }

    // Export QR als PNG
    function savePng() {
      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) { alert('Genereer eerst de QR.'); return; }
      const link = document.createElement('a');
      link.download = 'betaal-qr.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // Kopieer payload
    async function copyPayload() {
      const txt = document.getElementById('payload').value;
      if (!txt) { alert('Geen payload om te kopiëren. Genereer eerst de QR.'); return; }
      try {
        await navigator.clipboard.writeText(txt);
        const old = document.getElementById('btnCopy').textContent;
        document.getElementById('btnCopy').textContent = 'Gekopieerd!';
        setTimeout(()=>document.getElementById('btnCopy').textContent = old, 1200);
      } catch {
        alert('Kopiëren mislukt. Selecteer en kopieer handmatig.');
      }
    }

    // Init
    bindQtyButtons();
    recalc();

    // Events
    document.getElementById('btnGen').addEventListener('click', generate);
    document.getElementById('btnSave').addEventListener('click', savePng);
    document.getElementById('btnCopy').addEventListener('click', copyPayload);
  </script>
</body>
</html>
