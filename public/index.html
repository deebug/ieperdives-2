<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POC — Duikmateriaal Huur (SEPA QR)</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background:#0b1220; color:#eaf2ff; }
    .app { max-width: 980px; margin: 0 auto; display: grid; gap: var(--gap); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .card { background: #121a2c; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; }
    .grid { display:grid; gap: var(--gap); }
    .items { display:grid; grid-template-columns: 1fr auto auto auto; gap: 10px; align-items:center }
    .items > div { padding: 10px 0; border-bottom: 1px dashed #28365b; }
    .items .hdr { font-weight:600; color:#bcd3ff; border-bottom-color:#3a4f82; }
    .price, .line { text-align:right; font-variant-numeric: tabular-nums; }
    .qtywrap { display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .qtybtn {
      min-width: 44px; min-height: 44px; border-radius: 10px; border:1px solid #2a3d67;
      background:#0f1627; color:#eaf2ff; font-size: 20px; line-height: 1; padding: 0 0 2px;
      touch-action: manipulation; user-select: none;
    }
    .qtyval {
      width: 64px; text-align:center; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
      background:#0f1627; color:#eaf2ff; font-variant-numeric: tabular-nums;
    }
    .totals { display:flex; justify-content: flex-end; gap: 16px; align-items: baseline; }
    .totals .label { color:#bcd3ff; }
    .totals .amount { font-size: 22px; font-weight: 700; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"] { width: 100%; }
    input, select, button, textarea {
      background:#0f1627; color:#eaf2ff; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
    }
    button { cursor:pointer; }
    button.primary { background:#2d67ff; border-color:#2d67ff; color:white; }
    button.ghost { background:transparent; }
    .qrwrap { display:flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    #qrcode { background:white; padding:10px; border-radius:12px; }
    .small { color:#9db6ff; font-size: 12px; }
    code { background:#0f1627; padding:2px 6px; border-radius:6px; border:1px solid #2a3d67; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color:#9db6ff; }
    a { color:#b3c9ff; }
    @media (max-width: 640px){
      .items { grid-template-columns: 1fr auto 1fr auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="grid">
      <h1>POC — Duikmateriaal Huur (SEPA QR)</h1>
      <p class="muted">Kies aantallen met +/–, we berekenen het huurbedrag en maken een EPC-QR (SCT) naar een fictieve rekening. Mededeling = samenvatting van onderdelen (automatisch afgekapt tot 140 tekens).</p>
    </header>

    <!-- Artikelen met huurprijzen (fictief, per dag) -->
    <section class="card grid">
      <h2 style="margin:0">Artikelen (huurprijs/dag)</h2>
      <div class="items mono">
        <div class="hdr">Artikel</div>
        <div class="hdr price">€/dag</div>
        <div class="hdr" style="text-align:right">Aantal</div>
        <div class="hdr line">Lijn (€)</div>

        <div>Handschoenen</div>
        <div class="price" data-price="4.50">4,50</div>
        <div class="qtywrap" data-sku="HANDSCHOENEN">
          <button class="qtybtn" data-action="dec" aria-label="verlaag">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc" aria-label="verhoog">+</button>
        </div>
        <div class="line" data-line="HANDSCHOENEN">0,00</div>

        <div>Vinnen</div>
        <div class="price" data-price="9.00">9,00</div>
        <div class="qtywrap" data-sku="VINNEN">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="VINNEN">0,00</div>

        <div>Schoenen</div>
        <div class="price" data-price="5.00">5,00</div>
        <div class="qtywrap" data-sku="Schoenen">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="BOTJES">0,00</div>

        <div>Jacket / BCD</div>
        <div class="price" data-price="25.00">25,00</div>
        <div class="qtywrap" data-sku="JACKET">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="JACKET">0,00</div>

        <div>Masker</div>
        <div class="price" data-price="6.00">6,00</div>
        <div class="qtywrap" data-sku="MASKER">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="MASKER">0,00</div>
      </div>

      <div class="totals">
        <div class="label">Totaal (€):</div>
        <div id="total" class="amount mono">€ 0,00</div>
      </div>
    </section>

    <!-- Ontvanger & QR -->
    <section class="card grid">
      <h2 style="margin:0">Ontvanger (fictief)</h2>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap: var(--gap);">
        <label>Rekeninghouder
          <input id="benefName" type="text" value="DIVE RENTALS POC" />
        </label>
        <label>IBAN (fictief)
          <input id="iban" class="mono" type="text" value="BE68008200123456" />
        </label>
        <label>BIC (optioneel)
          <input id="bic" class="mono" type="text" value="GEBABEBB" />
        </label>
        <label>Mededeling (automatisch)
          <input id="remit" type="text" placeholder="auto gegenereerd" />
        </label>
      </div>
      <p class="small">EPC-SCT payload met ongestructureerde mededeling (max. 140 tekens). We kappen automatisch af.</p>
    </section>

    <section class="card grid">
      <h2 style="margin:0">Genereer QR</h2>
      <div class="row">
        <button id="btnGen" class="primary">Genereer Betaal-QR</button>
        <button id="btnCopy" class="ghost">Kopieer EPC-payload</button>
        <button id="btnSave" class="ghost">Download QR (PNG)</button>
      </div>

      <div class="qrwrap">
        <div id="qrcode"></div>
        <div class="grid" style="min-width: 300px;">
          <div><strong>EPC-payload</strong></div>
          <textarea id="payload" rows="10" class="mono" spellcheck="false" readonly></textarea>
          <div class="small">Scanbaar in de meeste EU-bankapps (SCT). Dit is een demonstratie met fictieve rekening.</div>
        </div>
      </div>
    </section>

    <footer class="small muted">
      Tip: pas prijzen of labels aan in de HTML. Touch-knoppen werken ook bij lang ingedrukt houden (auto-repeat).
    </footer>
  </div>

  <!-- QRCode.js (davidshimjs) MIT — echte QR encoder, compact minified -->
  <script src="/jquery.min.js"></script>
  <script src="/qrcode.min.js"></script>

  <script>
    // ——— Helpers ———
    const eur = (n) => new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(n);
    const dot2 = (n) => (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const MAX_REMIT = 140; // EPC ongestructureerde mededeling max 140 tekens

    // Lees items/prijzen
    const items = Array.from(document.querySelectorAll('.price')).map(p => {
      const price = Number(p.dataset.price);
      const label = p.previousElementSibling.textContent.trim();
      const sku = p.nextElementSibling.dataset.sku;
      const qtyInput = p.nextElementSibling.querySelector('.qtyval');
      return { sku, label, price, qtyInput };
    });

    // Recalc & UI update
    function recalc() {
      let total = 0;
      items.forEach(({ sku, price, qtyInput }) => {
        const qty = clamp(parseInt(qtyInput.value || '0',10) || 0, 0, 999);
        qtyInput.value = qty;
        const line = qty * price;
        total += line;
        document.querySelector(`[data-line="${sku}"]`).textContent = line ? line.toFixed(2).replace('.', ',') : '0,00';
      });
      document.getElementById('total').textContent = eur(total);
      // Update automatische mededeling placeholder
      document.getElementById('remit').placeholder = buildRemittance(true);
      return total;
    }

    // Touch-friendly +/− knoppen + auto-repeat bij ingedrukt houden
    function bindQtyButtons() {
      document.querySelectorAll('.qtywrap').forEach(wrap => {
        const input = wrap.querySelector('.qtyval');
        const dec = wrap.querySelector('[data-action="dec"]');
        const inc = wrap.querySelector('[data-action="inc"]');

        const step = (delta)=>{ input.value = clamp((parseInt(input.value||'0',10)||0) + delta, 0, 999); recalc(); };

        let holdTimer=null, repeatTimer=null;
        function startHold(delta){
          step(delta);
          holdTimer=setTimeout(()=>{
            repeatTimer=setInterval(()=>step(delta), 70);
          }, 350);
        }
        function endHold(){
          clearTimeout(holdTimer); clearInterval(repeatTimer);
          holdTimer=null; repeatTimer=null;
        }

        // Click / keyboard
        dec.addEventListener('click', ()=>step(-1));
        inc.addEventListener('click', ()=>step(1));
        // Pointer (voor touch hold)
        ['pointerdown','mousedown','touchstart'].forEach(evt=>{
          dec.addEventListener(evt, e=>{ e.preventDefault(); startHold(-1); });
          inc.addEventListener(evt, e=>{ e.preventDefault(); startHold(1); });
        });
        ['pointerup','mouseleave','mouseup','touchend','touchcancel'].forEach(evt=>{
          dec.addEventListener(evt, endHold);
          inc.addEventListener(evt, endHold);
        });
        // Handmatige invoer
        input.addEventListener('input', recalc);
        input.addEventListener('blur', ()=>{ input.value = clamp(parseInt(input.value||'0',10)||0,0,999); recalc(); });
      });
    }

    // EPC payload builder (SCT)
    function buildEpcPayload({ name, iban, bic, amount, remittance }) {
      const lines = [
        'BCD',           // Service tag
        '001',           // Version
        '1',             // Character set (UTF-8)
        'SCT',           // Identification (SEPA Credit Transfer)
        (bic || '').toUpperCase().trim(),
        (name || '').trim().slice(0,70),
        (iban || '').replace(/\s+/g, '').toUpperCase(),
        'EUR' + dot2(amount || 0),
        '',              // Purpose (optional)
        '',              // Structured reference (unused here)
        (remittance || '').trim().slice(0, MAX_REMIT),
        ''               // Beneficiary to originator info (optional)
      ];
      return lines.join('\n');
    }

    // Mededeling op basis van gekozen items, afkappen tot 140 tekens
    function buildRemittance(forPlaceholder=false) {
      const parts = items
        .map(({ label, qtyInput }) => {
          const qty = parseInt(qtyInput.value||'0',10) || 0;
          if (!qty) return null;
          const base = label.split('(')[0].trim(); // korter
          return `${base}×${qty}`;
        })
        .filter(Boolean);

      // Tijdstempel kort
      const ts = new Date().toISOString().slice(0,16).replace('T',' ').replace(/:/g,'');
      const suffix = ` — HUUR ${ts}`; // helpt unieke betaling herkennen

      let text = (parts.length ? parts.join(' / ') : 'GEEN SELECTIE') + suffix;
      if (text.length > MAX_REMIT) {
        // Kappen op woordgrens als kan
        text = text.slice(0, MAX_REMIT);
        const lastSep = text.lastIndexOf(' / ');
        if (lastSep > 0 && MAX_REMIT - lastSep < 10) {
          text = text.slice(0, lastSep);
        }
      }
      // Als placeholder, geen harde verplichting
      if (forPlaceholder) return text;
      // Indien gebruiker eigen tekst invulde, respecteer maar kap af in generate()
      const manual = document.getElementById('remit').value.trim();
      return manual ? manual.slice(0, MAX_REMIT) : text;
    }

    // QR component init (echte encoder)
    const qr = new QRCode('#qrcode', { text: '', width: 256, height: 256, correctLevel: 1 });

    function generate() {
      const total = recalc();
      const name = document.getElementById('benefName').value || 'DIVE RENTALS POC';
      const iban = document.getElementById('iban').value || 'BE68008200123456';
      const bic  = document.getElementById('bic').value || 'GEBABEBB';
      const remittance = buildRemittance(false);

      const payload = buildEpcPayload({ name, iban, bic, amount: total, remittance });
      document.getElementById('payload').value = payload;

      qr.clear();
      qr.makeCode(payload);
    }

    // Export QR als PNG
    function savePng() {
      const canvas = document.querySelector('#qrcode canvas');
      if (!canvas) { alert('Genereer eerst de QR.'); return; }
      const link = document.createElement('a');
      link.download = 'betaal-qr.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    // Kopieer payload
    async function copyPayload() {
      const txt = document.getElementById('payload').value;
      if (!txt) { alert('Geen payload om te kopiëren. Genereer eerst de QR.'); return; }
      try {
        await navigator.clipboard.writeText(txt);
        const old = document.getElementById('btnCopy').textContent;
        document.getElementById('btnCopy').textContent = 'Gekopieerd!';
        setTimeout(()=>document.getElementById('btnCopy').textContent = old, 1200);
      } catch {
        alert('Kopiëren mislukt. Selecteer en kopieer handmatig.');
      }
    }

    // Init
    bindQtyButtons();
    recalc();

    // Events
    document.getElementById('btnGen').addEventListener('click', generate);
    document.getElementById('btnSave').addEventListener('click', savePng);
    document.getElementById('btnCopy').addEventListener('click', copyPayload);
  </script>
</body>
</html>
