<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POC — Duikmateriaal Huur (SEPA QR)</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background:#0b1220; color:#eaf2ff; }
    .app { max-width: 980px; margin: 0 auto; display: grid; gap: var(--gap); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .card { background: #121a2c; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; }
    .grid { display:grid; gap: var(--gap); }
    .items { display:grid; grid-template-columns: 1fr auto auto auto; gap: 10px; align-items:center }
    .items > div { padding: 10px 0; border-bottom: 1px dashed #28365b; }
    .items .hdr { font-weight:600; color:#bcd3ff; border-bottom-color:#3a4f82; }
    .price, .line { text-align:right; font-variant-numeric: tabular-nums; }
    .qtywrap { display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .qtybtn {
      min-width: 44px; min-height: 44px; border-radius: 10px; border:1px solid #2a3d67;
      background:#0f1627; color:#eaf2ff; font-size: 20px; line-height: 1; padding: 0 0 2px;
      touch-action: manipulation; user-select: none;
    }
    .qtyval {
      width: 64px; text-align:center; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
      background:#0f1627; color:#eaf2ff; font-variant-numeric: tabular-nums;
    }
    .totals { display:flex; justify-content: flex-end; gap: 8px; align-items: baseline; }
    .totals .label { color:#bcd3ff; }
    .totals .amount { font-size: 22px; font-weight: 700; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    input[type="text"] { width: 100%; }
    input, select, button, textarea {
      background:#0f1627; color:#eaf2ff; border:1px solid #2a3d67; border-radius:10px; padding:10px 12px;
    }
    button { cursor:pointer; }
    button.primary { background:#2d67ff; border-color:#2d67ff; color:white; }
    button.ghost { background:transparent; }
    .qrwrap { display:flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    #qrcode { background:white; padding:10px; border-radius:12px; }
    .small { color:#9db6ff; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color:#9db6ff; }
    @media (max-width: 640px){
      .items { grid-template-columns: 1fr auto 1fr auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="grid">
      <h1>POC — Duikmateriaal Huur (SEPA QR)</h1>
      <p class="muted">Kies aantallen met +/–, we berekenen het huurbedrag en maken een EPC-QR (SCT) naar een fictieve rekening. Mededeling = samenvatting (afgekapt tot 140 bytes).</p>
    </header>

    <!-- Artikelen met huurprijzen (fictief, per dag) -->
    <section class="card grid">
      <h2 style="margin:0">Artikelen (huurprijs/dag)</h2>
      <div class="items mono">
        <div class="hdr">Artikel</div>
        <div class="hdr price">€/dag</div>
        <div class="hdr" style="text-align:right">Aantal</div>
        <div class="hdr line">Lijn (€)</div>

        <div>Handschoenen (5 mm neopreen)</div>
        <div class="price" data-price="4.50">4,50</div>
        <div class="qtywrap" data-sku="HANDSCHOENEN">
          <button class="qtybtn" data-action="dec" aria-label="verlaag">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc" aria-label="verhoog">+</button>
        </div>
        <div class="line" data-line="HANDSCHOENEN">0,00</div>

        <div>Vinnen (open heel)</div>
        <div class="price" data-price="9.00">9,00</div>
        <div class="qtywrap" data-sku="VINNEN">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="VINNEN">0,00</div>

        <div>Botjes (schoenen met rits)</div>
        <div class="price" data-price="5.00">5,00</div>
        <div class="qtywrap" data-sku="BOTJES">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="BOTJES">0,00</div>

        <div>Jacket / BCD ("jockey")</div>
        <div class="price" data-price="25.00">25,00</div>
        <div class="qtywrap" data-sku="JACKET">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="JACKET">0,00</div>

        <div>Masker (gehard glas)</div>
        <div class="price" data-price="6.00">6,00</div>
        <div class="qtywrap" data-sku="MASKER">
          <button class="qtybtn" data-action="dec">−</button>
          <input class="qtyval" type="number" inputmode="numeric" min="0" step="1" value="0" />
          <button class="qtybtn" data-action="inc">+</button>
        </div>
        <div class="line" data-line="MASKER">0,00</div>
      </div>

      <div class="totals">
        <div class="label">Totaal (€/dag):</div>
        <div id="total" class="amount mono">€ 0,00</div>
      </div>
    </section>

    <!-- Ontvanger & QR -->
    <section class="card grid">
      <h2 style="margin:0">Ontvanger (fictief)</h2>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap: var(--gap);">
        <label>Rekeninghouder
          <input id="benefName" type="text" value="DIVE RENTALS POC" />
        </label>
        <label>IBAN (fictief)
          <input id="iban" class="mono" type="text" value="BE73001942760860" />
        </label>
        <label>BIC (optioneel)
          <input id="bic" class="mono" type="text" value="GEBABEBB" />
        </label>
        <label>Mededeling (automatisch)
          <input id="remit" type="text" placeholder="auto gegenereerd" />
        </label>
      </div>
      <p class="small">EPC-SCT payload met ongestructureerde mededeling (max. 140 bytes). We kappen automatisch af.</p>
    </section>

    <section class="card grid">
      <h2 style="margin:0">Genereer QR</h2>
      <div class="row">
        <button id="btnGen" class="primary">Genereer Betaal-QR</button>
        <button id="btnCopy" class="ghost">Kopieer EPC-payload</button>
        <button id="btnSave" class="ghost">Download QR (PNG)</button>
      </div>

      <div class="qrwrap">
        <div id="qrcode"></div>
        <div class="grid" style="min-width: 300px;">
          <div><strong>EPC-payload</strong></div>
          <textarea id="payload" rows="10" class="mono" spellcheck="false" readonly></textarea>
          <div class="small">Scanbaar in de meeste EU-bankapps (SCT). Dit is een demonstratie met fictieve rekening.</div>
        </div>
      </div>
    </section>

    <footer class="small muted">
      Tip: lang indrukken op +/− zorgt voor auto-repeat. IBAN/BIC/naam kun je altijd aanpassen.
    </footer>
  </div>

  <!-- Externe libs (onderaan body, juiste volgorde) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- App logic -->
  <script>
    // ===== Helpers =====
    const eur = (n) => {
      const safe = (isFinite(n) && !isNaN(n)) ? n : 0;
      return new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR' }).format(safe);
    };
    const dot2 = (n) => (Math.round((Number(n) + Number.EPSILON) * 100) / 100).toFixed(2);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,Number.isFinite(v)?v:0));

    // — parsing prijs uit data-price (robust)
    function parsePrice(el){
      // data-price moet in puntnotatie staan; fallback: innerText met komma → punt
      const ds = el.getAttribute('data-price');
      if (ds != null) {
        const p = parseFloat(String(ds).replace(',','.'));
        if (!isNaN(p)) return p;
      }
      const txt = el.textContent.trim().replace(/\./g,'').replace(',','.');
      const p2 = parseFloat(txt);
      return isNaN(p2) ? 0 : p2;
    }

    // UTF-8 utils voor QR
    function byteLen(str){ return new TextEncoder().encode(str).length; }
    function truncateBytes(str, maxBytes){
      const enc = new TextEncoder();
      let lo = 0, hi = str.length;
      while (lo < hi){
        const mid = (lo + hi + 1) >> 1;
        if (enc.encode(str.slice(0, mid)).length <= maxBytes) lo = mid; else hi = mid - 1;
      }
      return str.slice(0, lo);
    }
    function toAsciiSafe(s){
      return s
        .normalize('NFKD').replace(/[\u0300-\u036f]/g,'') // accenten weg
        .replace(/×/g,'x').replace(/[—–]/g,'-')           // speciale tekens
        .replace(/[^\w\s\/\-\+\:\.\,]/g,'')               // rare symbolen
        .replace(/\s+/g,' ').trim().toUpperCase();
    }

    // ===== Data uit DOM =====
    const items = [];
    document.querySelectorAll('.items .price').forEach(priceEl=>{
      const label = priceEl.previousElementSibling.textContent.trim();
      const price = parsePrice(priceEl); // robuust
      const wrap  = priceEl.nextElementSibling;   // .qtywrap
      const sku   = wrap.getAttribute('data-sku');
      const input = wrap.querySelector('.qtyval');
      items.push({ sku, label, price, input, lineEl: document.querySelector(`[data-line="${sku}"]`) });
    });

    // ===== Berekening + UI =====
    function updateLinesAndTotal(){
      let total = 0;
      for (const row of items){
        const qty = clamp(parseInt(row.input.value || '0',10) || 0, 0, 999);
        row.input.value = qty;
        const line = qty * row.price;
        total += (isFinite(line) && !isNaN(line)) ? line : 0;
        row.lineEl.textContent = (line > 0 ? dot2(line).replace('.', ',') : '0,00');
      }
      document.getElementById('total').textContent = eur(total);
      document.getElementById('remit').placeholder = buildRemittance(true);
      return total;
    }

    function bindQty(){
      document.querySelectorAll('.qtywrap').forEach(wrap=>{
        const input = wrap.querySelector('.qtyval');
        const dec = wrap.querySelector('[data-action="dec"]');
        const inc = wrap.querySelector('[data-action="inc"]');

        const step = (d)=>{ input.value = clamp((parseInt(input.value||'0',10)||0)+d, 0, 999); updateLinesAndTotal(); };

        let holdTimer=null, repeatTimer=null;
        const startHold=(d)=>{ step(d); holdTimer=setTimeout(()=>{ repeatTimer=setInterval(()=>step(d),70); },350); };
        const endHold=()=>{ clearTimeout(holdTimer); clearInterval(repeatTimer); holdTimer=repeatTimer=null; };

        dec.addEventListener('click', ()=>step(-1));
        inc.addEventListener('click', ()=>step(1));
        ['pointerdown','mousedown','touchstart'].forEach(evt=>{
          dec.addEventListener(evt, e=>{ e.preventDefault(); startHold(-1); });
          inc.addEventListener(evt, e=>{ e.preventDefault(); startHold(1); });
        });
        ['pointerup','mouseleave','mouseup','touchend','touchcancel'].forEach(evt=>{
          dec.addEventListener(evt, endHold);
          inc.addEventListener(evt, endHold);
        });
        input.addEventListener('input', updateLinesAndTotal);
        input.addEventListener('blur', ()=>{ input.value = clamp(parseInt(input.value||'0',10)||0,0,999); updateLinesAndTotal(); });
      });
    }

    // ===== Remittance + Payload =====
    const MAX_REMIT_BYTES = 140;

    function buildRemittance(asPlaceholder=false){
      const parts = items.map(r=>{
        const qty = parseInt(r.input.value||'0',10) || 0;
        if (!qty) return null;
        const base = r.label.split('(')[0].trim();
        return `${base}x${qty}`; // ASCII 'x'
      }).filter(Boolean);

      const ts = new Date().toISOString().slice(0,16).replace('T','').replace(':',''); // 202510132015
      let text = (parts.length ? parts.join(' / ') : 'GEEN SELECTIE') + ` - HUUR ${ts}`;
      text = toAsciiSafe(text);
      if (byteLen(text) > MAX_REMIT_BYTES) text = truncateBytes(text, MAX_REMIT_BYTES);

      if (asPlaceholder) return text;
      const manual = document.getElementById('remit').value.trim();
      const chosen = manual ? toAsciiSafe(manual) : text;
      return (byteLen(chosen) > MAX_REMIT_BYTES) ? truncateBytes(chosen, MAX_REMIT_BYTES) : chosen;
    }

    function buildEpcPayload({ name, iban, bic, amount, remittance }){
      const lines = [
        'BCD','001','1','SCT',
        (bic||'').toUpperCase().trim(),
        toAsciiSafe((name||'').slice(0,70)),
        (iban||'').replace(/\s+/g,'').toUpperCase(),
        'EUR'+dot2(amount||0),
        '',
        '',
        remittance,
        ''
      ];
      return lines.join('\n');
    }

    function renderQR(payload){
      const box = document.getElementById('qrcode');
      box.innerHTML = '';
      new QRCode(box, {
        text: payload,
        width: 256,
        height: 256,
        correctLevel: QRCode.CorrectLevel.L // maximale capaciteit
      });
    }

    // ===== Actions =====
    function generate(){
      const total = updateLinesAndTotal();
      const name = document.getElementById('benefName').value || 'DIVE RENTALS POC';
      const iban = document.getElementById('iban').value || 'BE73001942760860';
      const bic  = document.getElementById('bic').value  || 'GEBABEBB';
      const rem  = buildRemittance(false);

      const payload = buildEpcPayload({ name, iban, bic, amount: total, remittance: rem });
      document.getElementById('payload').value = payload;
      renderQR(payload);
    }

    async function copyPayload(){
      const txt = document.getElementById('payload').value;
      if (!txt) return alert('Geen payload om te kopiëren. Genereer eerst de QR.');
      try { await navigator.clipboard.writeText(txt); alert('Gekopieerd!'); }
      catch { alert('Kopiëren mislukt. Selecteer en kopieer handmatig.'); }
    }

    function savePng(){
      const c = document.querySelector('#qrcode canvas');
      const img = document.querySelector('#qrcode img');
      if (c){
        const a = document.createElement('a');
        a.download = 'betaal-qr.png';
        a.href = c.toDataURL('image/png'); a.click();
      } else if (img){
        const a = document.createElement('a');
        a.download = 'betaal-qr.png';
        a.href = img.src; a.click();
      } else {
        alert('Genereer eerst de QR.');
      }
    }

    // ===== Init =====
    bindQty();
    updateLinesAndTotal();
    document.getElementById('btnGen').addEventListener('click', generate);
    document.getElementById('btnCopy').addEventListener('click', copyPayload);
    document.getElementById('btnSave').addEventListener('click', savePng);
  </script>
</body>
</html>
